var Q=Object.defineProperty;var V=(R,t,n)=>t in R?Q(R,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):R[t]=n;var L=(R,t,n)=>V(R,typeof t!="symbol"?t+"":t,n);class j{constructor(){L(this,"underlineElements",[]);L(this,"rectCharIndexMapping",[])}buildRectCharIndexMapping(){let t=0,n=!0;this.rectCharIndexMapping=[],document.querySelectorAll("div.kix-canvas-tile-content > svg").forEach(s=>{s.querySelectorAll("g[role='paragraph']").forEach(r=>{const i=r.querySelectorAll("rect");i.length!==0&&(n||(t+=1),n=!1,i.forEach((m,x)=>{const e=m.getAttribute("aria-label");if(e){if(x>0){const o=i[x-1];if(o){const l=parseFloat(o.getAttribute("x"))+parseFloat(o.getAttribute("width")),b=parseFloat(m.getAttribute("x"));Math.abs(l-b)>=.01&&(t+=1)}}this.rectCharIndexMapping.push({rectElement:m,text:e,startCharIndex:t,endCharIndex:t+e.length,svgElement:s,paragraph:r}),t+=e.length}}))})})}applyUnderlines(t,n){const a=new Set;this.underlineElements.forEach(r=>{a.add(`${r.originalText}-${r.error_type}`)}),this.underlineElements=[];const s=new Map;document.querySelectorAll("div.kix-canvas-tile-content > svg").forEach(r=>{let i=r.querySelector('g[data-enhanced-text-tracker="underline-group"]');for(i||(i=document.createElementNS("http://www.w3.org/2000/svg","g"),i.setAttribute("data-enhanced-text-tracker","underline-group"),r.appendChild(i));i.firstChild;)i.removeChild(i.firstChild)}),t.forEach(r=>{const i=r.start,m=r.end,x=r.corrected_text,e=r.error_type,o=r.originalText,l=`${i}-${m}-${e}`;s.set(l,{correction:r,elements:[]}),this.rectCharIndexMapping.filter(c=>c.startCharIndex<m&&c.endCharIndex>i).forEach(c=>{const g=c.rectElement,u=c.svgElement,C=parseFloat(g.getAttribute("x")),G=parseFloat(g.getAttribute("y")),F=parseFloat(g.getAttribute("height")),M=g.getAttribute("transform");let k=0,D=0;if(M){const E=M.match(/matrix\(.*?,.*?,.*?,.*?,(.*?),(.*?)\)/);E&&(k=parseFloat(E[1])||0,D=parseFloat(E[2])||0)}const w=C+k,h=G+D,v=document.createElement("canvas").getContext("2d"),S=window.getComputedStyle(g).font||"14px Arial";v.font=S;const p=c.text,f=j.findTextDifferences(o,x),B=c.startCharIndex-i,H=B+p.length;if(B<=f.oldEnd&&H>=f.oldStart){const E=Math.max(0,f.oldStart-B),N=Math.min(p.length,f.oldEnd-B);if(E<N){const K=p.slice(0,E),O=p.slice(E,N),P=v.measureText(K).width,T=v.measureText(O).width,q=w+P,_=q+T,U=h+F-2;let $=u.querySelector('g[data-enhanced-text-tracker="underline-group"]');$||($=document.createElementNS("http://www.w3.org/2000/svg","g"),$.setAttribute("data-enhanced-text-tracker","underline-group"),u.appendChild($));const y=document.createElementNS("http://www.w3.org/2000/svg","g");y.setAttribute("data-enhanced-text-tracker","underline-element"),n&&y.classList.add("animate");const A=document.createElementNS("http://www.w3.org/2000/svg","rect");A.setAttribute("x",q),A.setAttribute("y",h),A.setAttribute("width",(_-q).toString()),A.setAttribute("height",(F+2).toString()),A.setAttribute("fill","rgba(0, 0, 0, 0)"),A.setAttribute("pointer-events","all");const d=document.createElementNS("http://www.w3.org/2000/svg","line");d.setAttribute("x1",q.toString()),d.setAttribute("y1",U.toString()),d.setAttribute("x2",_.toString()),d.setAttribute("y2",U.toString()),d.setAttribute("stroke",e==="Grammar"?"#FF6347":"#4682B4"),d.setAttribute("stroke-width","2"),d.setAttribute("stroke-opacity","0.6"),d.setAttribute("pointer-events","none");const z=`${o}-${e}`;a.has(z)&&d.classList.add("animated"),y.appendChild(A),y.appendChild(d),$.appendChild(y);const Y=u.getBoundingClientRect(),J={left:Y.left+q,top:Y.top+h,right:Y.left+_,bottom:Y.top+h+F+2,svgElement:u},W={rectElement:g,boundingRect:J,highlightRect:A,corrected_text:x,originalText:o,error_type:e,citations:r.citations,defaultColor:"rgba(0, 0, 0, 0)",hoverColor:e==="Grammar"?"rgba(255, 99, 71, 0.7)":"rgba(173, 216, 230, 0.7)",groupElement:y,groupId:l,diffInfo:{start:E,end:N,originalText:O,newText:f.newDiff}};this.underlineElements.push(W),s.get(l).elements.push(W)}}})})}static findTextDifferences(t,n){let a=0,s=0;for(;a<t.length&&a<n.length&&t[a]===n[a];)a++;for(;s<t.length-a&&s<n.length-a&&t[t.length-1-s]===n[n.length-1-s];)s++;return{oldStart:a,oldEnd:t.length-s,newStart:a,newEnd:n.length-s,oldDiff:t.slice(a,t.length-s),newDiff:n.slice(a,n.length-s)}}updateUnderlinePositions(){this.buildRectCharIndexMapping(),this.underlineElements.forEach(t=>{const n=t.originalText,a=this.rectCharIndexMapping.map(e=>e.text).join("");let s=-1;const I=[];for(;(s=a.indexOf(n,s+1))!==-1;)I.push(s);let r=I[0],i=1/0;const m=parseFloat(t.highlightRect.getAttribute("x"));I.forEach(e=>{const o=this.rectCharIndexMapping.filter(l=>l.startCharIndex<=e&&l.endCharIndex>e);if(o.length>0){const l=o[0],b=parseFloat(l.rectElement.getAttribute("x")),c=l.rectElement.getAttribute("transform");let g=0;if(c){const C=c.match(/matrix\(.*?,.*?,.*?,.*?,(.*?),(.*?)\)/);C&&(g=parseFloat(C[1])||0)}const u=Math.abs(b+g-m);u<i&&(i=u,r=e)}});const x=this.rectCharIndexMapping.filter(e=>e.startCharIndex<=r&&e.endCharIndex>r);if(x.length>0){const e=x[0],o=e.svgElement,b=document.createElement("canvas").getContext("2d"),c=window.getComputedStyle(e.rectElement).font||"14px Arial";b.font=c;const g=r-e.startCharIndex,u=e.text.substring(0,g),C=b.measureText(u).width,G=parseFloat(e.rectElement.getAttribute("x")),F=parseFloat(e.rectElement.getAttribute("y")),M=e.rectElement.getAttribute("transform");let k=0,D=0;if(M){const f=M.match(/matrix\(.*?,.*?,.*?,.*?,(.*?),(.*?)\)/);f&&(k=parseFloat(f[1])||0,D=parseFloat(f[2])||0)}const w=G+k+C,h=F+D,X=parseFloat(e.rectElement.getAttribute("height")),v=b.measureText(n).width;t.highlightRect.style.transition="x 0.2s, y 0.2s",t.groupElement.querySelector("line").style.transition="x1 0.2s, x2 0.2s, y1 0.2s, y2 0.2s",t.highlightRect.setAttribute("x",w.toString()),t.highlightRect.setAttribute("y",h.toString()),t.highlightRect.setAttribute("width",v.toString()),t.highlightRect.setAttribute("height",X.toString());const S=t.groupElement.querySelector("line");S.setAttribute("x1",w.toString()),S.setAttribute("x2",(w+v).toString()),S.setAttribute("y1",(h+X-2).toString()),S.setAttribute("y2",(h+X-2).toString());const p=o.getBoundingClientRect();t.boundingRect={left:p.left+w,top:p.top+h,right:p.left+w+v,bottom:p.top+h+X,svgElement:o}}})}}export{j as Underline};
